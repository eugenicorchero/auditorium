<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auditorum: Entrenador d'Intervals Musicals</title>
    <!-- Càrrega de Tailwind CSS per a un disseny responsive i ràpid -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Configuració de la tipografia i colors professionals */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            /* Fons fosc molt similar al de la imatge */
            background-color: #0b1122; /* Gairebé negre amb un toc blau fosc */
        }
        /* Estil per al botó de reproducció, per fer-lo destacar */
        #playButton {
            transition: all 0.1s ease;
            /* Utilitzem un ombrejat Blau, com el color dels botons d'Auditorum */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -2px rgba(0, 0, 0, 0.2);
        }
        /* Utilitzem un ombrejat Blau en l'estat hover */
        #playButton:hover {
            transform: scale(1.05);
            box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.4), 0 4px 6px -4px rgba(37, 99, 235, 0.3); /* blue-600 shadow */
        }
        /* Estil per a la barra de temps */
        #progressBar {
            transition: width 0.9s linear;
        }
        /* Estil per al pop-up d'error d'àudio */
        .audio-error-popup {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 50;
        }
        /* Ombrejat per als botons de dificultat (blau fosc) */
        .difficulty-button {
            background-color: #2563eb; /* Tailwind Blue-600 */
            transition: all 0.15s ease;
            box-shadow: 0 4px 14px 0 rgba(37, 99, 235, 0.5); /* Ombrejat blau intens */
        }
        .difficulty-button:hover {
            background-color: #1d4ed8; /* Tailwind Blue-700 */
        }
        /* Estat inicial de l'app quan l'àudio es carrega */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(11, 17, 34, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 1rem;
            z-index: 60;
            color: white;
            font-size: 1.25rem;
            border-radius: 0.75rem;
            padding: 2rem;
        }
    </style>
</head>

<body class="bg-gray-950 min-h-screen flex flex-col items-center justify-center p-4">

    <!-- POP-UP d'ERROR D'AUDIO -->
    <div id="audioErrorPopup" class="audio-error-popup hidden bg-red-600 text-white p-3 rounded-lg shadow-xl max-w-xs transition duration-300 transform scale-100">
        <p class="font-bold mb-1">⚠️ Error de Precàrrega</p>
        <p id="audioErrorMessage" class="text-sm">No s'han pogut carregar tots els fitxers d'àudio.</p>
        <p class="text-xs mt-1 opacity-80">Assegura't que el path i la nomenclatura dels arxius sigui correcta (ex: C4.mp3, D#4.mp3).</p>
    </div>

    <!-- Contenidor principal de l'aplicació: Fosc i amb ombra subtil -->
    <div id="appContainer" class="bg-gray-800 shadow-2xl rounded-xl w-full max-w-4xl p-8 md:p-12 border border-gray-700/50 mb-4 relative">
        
        <!-- Overlay de càrrega (Visible fins que es comprova/precàrrega l'àudio) -->
        <div id="loadingOverlay" class="loading-overlay">
            <p class="text-center font-semibold">Carregant fitxers d'àudio per a un joc instantani...</p>
            <div class="w-full bg-gray-600 rounded-full h-2.5 max-w-sm">
                <div id="preloaderBar" class="bg-blue-500 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
            </div>
            <p id="preloaderStatus" class="text-base text-gray-300"></p>
        </div>

        <!-- PANTALLA 1: SELECCIÓ DE DIFICULTAT -->
        <div id="difficultyScreen" class="opacity-0 transition-opacity duration-500">
            <header class="text-center mb-8 border-b border-blue-600 pb-4">
                <h1 class="text-4xl font-extrabold text-white tracking-tight">Auditorum</h1>
                <p class="text-xl text-blue-400 font-semibold mt-1">Entrenador d'Intervals Musicals</p>
            </header>

            <h2 class="text-2xl font-bold text-gray-100 mb-2 text-center">Benvingut/da! Tria el teu Nivell de Pràctica</h2>
            <p class="text-gray-400 text-center mb-8 max-w-xl mx-auto">Practica la identificació d'intervals musicals de forma visual. Selecciona un nivell de dificultat per començar. Recorda que tens 30 segons per a cada resposta.</p>

            <div class="grid md:grid-cols-3 gap-6 max-w-5xl mx-auto">
                <!-- Botons amb el color Blau Fosc i descripcions actualitzades segons la teva petició -->
                <button onclick="startGame('easy')" class="difficulty-button text-white font-semibold rounded-lg hover:brightness-110 p-6 flex flex-col items-center text-center">
                    <span class="text-xl font-bold mb-2">Fàcil</span>
                    <span class="text-sm opacity-90">Intervals: Uníson, 2a M, 3a M, 4a J, 5a J </span>
                </button>
                <button onclick="startGame('medium')" class="difficulty-button text-white font-semibold rounded-lg hover:brightness-110 p-6 flex flex-col items-center text-center">
                    <span class="text-xl font-bold mb-2">Mitjà</span>
                    <span class="text-sm opacity-90">Intervals: Uníson, 2a M, 3a M, 4a J, 5a J, 6a M, 7a M, Octava </span>
                </button>
                <button onclick="startGame('hard')" class="difficulty-button text-white font-semibold rounded-lg hover:brightness-110 p-6 flex flex-col items-center text-center">
                    <span class="text-xl font-bold mb-2">Difícil</span>
                    <span class="text-sm opacity-90">Tots els intervals (Ascendent i Descendent)</span>
                </button>
            </div>
        </div>

        <!-- PANTALLA 2: JOC / QUIZ -->
        <div id="quizScreen" class="hidden">
            <!-- Puntuació i Temporitzador -->
            <div class="flex justify-between items-center mb-6 border-b border-gray-700 pb-4">
                <div class="text-xl font-medium text-gray-300">Ronda: <span id="roundCount" class="font-bold text-blue-400">1</span></div>
                <div class="text-xl font-medium text-gray-300">Puntuació: <span id="score" class="font-bold text-blue-400">0</span></div>
            </div>

            <!-- Àrea de Reproducció i Temporitzador Visual -->
            <div class="text-center mb-8">
                <!-- Botó de reproducció Blau -->
                <button id="playButton" class="bg-blue-600 text-white p-4 rounded-full w-20 h-20 flex items-center justify-center mx-auto mb-4 hover:bg-blue-700 transition duration-200 focus:outline-none">
                    <!-- Icona de reproducció (SVG) -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                    </svg>
                </button>
                <p id="directionLabel" class="text-lg font-semibold text-gray-300 mb-4"></p>

                <!-- Barra de progrés del temporitzador (30 segons), utilitzant Blau -->
                <div class="w-full bg-gray-700 rounded-full h-2.5">
                    <div id="progressBar" class="bg-blue-600 h-2.5 rounded-full" style="width: 100%"></div>
                </div>
                <p class="text-sm text-gray-400 mt-2">Temps restant per escoltar: <span id="timeRemaining">30</span>s</p>
            </div>

            <!-- Botons d'Opció d'Interval (Es generaran per JS) -->
            <div id="intervalOptions" class="grid gap-3 mt-8" style="grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));">
                <!-- Botons injectats aquí -->
            </div>
            
            <!-- Missatge de retroalimentació (Feedback) -->
            <div id="feedbackMessage" class="mt-6 text-center text-lg font-bold min-h-6"></div>

            <!-- Botó de següent ronda (inicialment amagat) -->
            <button id="nextRoundButton" class="hidden w-full py-3 mt-6 bg-gray-700 text-white font-semibold rounded-lg hover:bg-gray-600 transition duration-150 shadow-lg">
                Següent Ronda
            </button>
        </div>

        <!-- PANTALLA 3: RESULTATS FINALS -->
        <div id="resultScreen" class="hidden text-center">
            <h2 class="text-3xl font-bold text-gray-100 mb-4">Resultats Finals</h2>
            <p class="text-xl text-gray-400 mb-6">Has completat la pràctica!</p>
            <p class="text-4xl font-extrabold text-blue-400 mb-8">Puntuació Final: <span id="finalScore">0</span></p>

            <!-- Botó de reset amb color principal (Blau) -->
            <button onclick="resetGame()" class="w-full py-4 px-6 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-150 shadow-md">
                Tornar a començar
            </button>
        </div>

    </div>
    
    <!-- Footer/Copyright -->
    <footer class="text-center text-sm text-gray-400 mt-4 max-w-4xl w-full">
        <p>Copyright &copy; Eugeni Corchero 2025</p>
    </footer>


    <!-- LÒGICA JAVASCRIPT -->
    <script>
        // ===============================================
        // VARIABLES GLOBALS I CONFIGURACIÓ
        // ===============================================

        // *****************************************************************
        // CORRECCIÓ 1: ÚS DE LA RUTA RAW DE GITHUB AMB LA TEVA ESTRUCTURA
        // Utilitzem la ruta raw per garantir que els fitxers siguin accessibles.
        // Assumim que la teva carpeta es diu 'audio' dins de 'auditorium'
        // *****************************************************************
        const AUDIO_PATH = 'https://raw.githubusercontent.com/eugenicorchero/auditorum/main/audio/'; 
        
        const MIDI_START = 57; // A3 (Nota més baixa)
        const MIDI_END = 72;   // C5 (Nota més alta)
        const TOTAL_MIDI_NOTES = MIDI_END - MIDI_START + 1; // 16 notes
        const TIMER_DURATION = 30; // Temps en segons

        // CACHE: Emmagatzemarà tots els objectes Audio ja carregats
        const audioCache = {};

        // Mapa de semitons a noms d'intervals 
        const INTERVAL_NAMES = {
            0: 'Uníson', 1: '2a menor', 2: '2a Major', 3: '3a menor',
            4: '3a Major', 5: '4a Justa', 6: 'Tríton', // 4a Aug/5a Dim
            7: '5a Justa', 8: '6a menor', 9: '6a Major',
            10: '7a menor', 11: '7a Major', 12: '8a Justa'
        };

        // Tots els 13 intervals (0 a 12 semitons)
        const ALL_INTERVALS = Object.keys(INTERVAL_NAMES).map(Number);

        // CONFIGURACIÓ DELS NIVELLS DE DIFICULTAT
        const DIFFICULTY_CONFIG = {
            easy: {
                // Intervals: Uníson, 2a M, 3a M, 4a J, 5a J (0, 2, 4, 5, 7)
                intervals: [0, 2, 4, 5, 7], 
                directions: ['Ascendent']
            },
            medium: {
                // Intervals: Uníson, 2a M, 3a M, 4a J, 5a J, 6a M, 7a M, Octava (0, 2, 4, 5, 7, 9, 11, 12)
                intervals: [0, 2, 4, 5, 7, 9, 11, 12], 
                directions: ['Ascendent', 'Descendent', 'Harmònic']
            },
            hard: {
                // Tots els 13 intervals cromàtics (0 a 12)
                intervals: ALL_INTERVALS, 
                directions: ['Ascendent', 'Descendent'] 
            }
        };
        
        // Estats del joc
        let gameState = {
            difficulty: null,
            score: 0,
            round: 0,
            correctIntervalSemitones: null,
            timer: null,
            timeRemaining: TIMER_DURATION,
            currentDirection: null,
            isAnswered: false,
            baseNoteMIDI: null, 
            intervalNoteMIDI: null,
            currentInterval: null,
            isAudioReady: false, 
        };

        // Referències al DOM
        const screens = {
            difficulty: document.getElementById('difficultyScreen'),
            quiz: document.getElementById('quizScreen'),
            result: document.getElementById('resultScreen')
        };
        const elements = {
            roundCount: document.getElementById('roundCount'),
            score: document.getElementById('score'),
            playButton: document.getElementById('playButton'),
            progressBar: document.getElementById('progressBar'),
            timeRemaining: document.getElementById('timeRemaining'),
            intervalOptions: document.getElementById('intervalOptions'),
            feedbackMessage: document.getElementById('feedbackMessage'),
            nextRoundButton: document.getElementById('nextRoundButton'),
            directionLabel: document.getElementById('directionLabel'),
            finalScore: document.getElementById('finalScore'),
            audioErrorPopup: document.getElementById('audioErrorPopup'),
            audioErrorMessage: document.getElementById('audioErrorMessage'),
            loadingOverlay: document.getElementById('loadingOverlay'),
            preloaderBar: document.getElementById('preloaderBar'),
            preloaderStatus: document.getElementById('preloaderStatus'),
        };


        // ===============================================
        // UTILS D'ÀUDIO I MIDI (CORRECCIÓ DE NOMENCLATURA)
        // ===============================================
        
        /**
         * Converteix un número MIDI a nom de fitxer MP3 (ex: 60 -> C4.mp3).
         * CORRECCIÓ 2: Utilitza la nomenclatura amb 's' per als fitxers de GitHub (ex: Cs4, As3).
         * @param {number} midiNumber - El número MIDI.
         * @returns {string} El nom del fitxer (incloent la ruta).
         */
        function getFileName(midiNumber) {
            // Correspondència de MIDI a nota i octava
            const notes = ['C', 'Cs', 'D', 'Ds', 'E', 'F', 'Fs', 'G', 'Gs', 'A', 'As', 'B'];
            const octave = Math.floor(midiNumber / 12) - 1;
            const noteIndex = midiNumber % 12;
            let noteName = notes[noteIndex];

            // Casos especials on la nomenclatura no utilitza 's' (C, D, E, F, G, A, B)
            if (noteName.length > 1 && !noteName.endsWith('s')) {
                 // Aquest codi és segur, però donat que el teu array notes[] ja utilitza la 's' per als sostinguts,
                 // l'única cosa que necessitem és afegir l'octava.
            }

            // A3 (MIDI 57) i A4 (MIDI 69) no tenen 's'
            if (midiNumber === 57 || midiNumber === 69) noteName = 'A';
            // B3 (MIDI 59) i B4 (MIDI 71) no tenen 's'
            if (midiNumber === 59 || midiNumber === 71) noteName = 'B';
            // C4 (MIDI 60) i C5 (MIDI 72) no tenen 's'
            if (midiNumber === 60 || midiNumber === 72) noteName = 'C';
            // D4 (MIDI 62) no tenen 's'
            if (midiNumber === 62) noteName = 'D';
            // E4 (MIDI 64) no tenen 's'
            if (midiNumber === 64) noteName = 'E';
            // F4 (MIDI 65) no tenen 's'
            if (midiNumber === 65) noteName = 'F';
            // G4 (MIDI 67) no tenen 's'
            if (midiNumber === 67) noteName = 'G';


            // Corregim l'array de notes per reflectir la teva nomenclatura (sense el símbol '#' però amb 's')
            const notesMap = [
                'C', 'Cs', 'D', 'Ds', 'E', 'F', 'Fs', 'G', 'Gs', 'A', 'As', 'B'
            ];
            const finalNoteName = notesMap[noteIndex];
            
            // Retorna nom de fitxer per a la càrrega
            return `${AUDIO_PATH}${finalNoteName}${octave}.mp3`;
        }
        
        /**
         * Precàrrega (Pre-load) de tots els fitxers d'àudio del rang MIDI (57-72).
         */
        function preloadAllAudio() {
            return new Promise((resolve, reject) => {
                let notesLoaded = 0;
                let errors = 0;
                let failedFiles = [];

                const onLoaded = (midiNumber, isError) => {
                    notesLoaded++;
                    if (isError) errors++;
                    
                    // Actualitzar barra de progrés
                    const percentage = Math.round((notesLoaded / TOTAL_MIDI_NOTES) * 100);
                    elements.preloaderBar.style.width = `${percentage}%`;
                    elements.preloaderStatus.textContent = `Carregades ${notesLoaded}/${TOTAL_MIDI_NOTES} notes. ${errors > 0 ? '(' + errors + ' errors)' : ''}`;

                    if (notesLoaded === TOTAL_MIDI_NOTES) {
                        if (errors === 0) {
                            resolve();
                        } else {
                            // En cas d'error, resolem amb les dades dels errors
                            reject({
                                errorCount: errors,
                                failedFiles: failedFiles
                            });
                        }
                    }
                };

                for (let midi = MIDI_START; midi <= MIDI_END; midi++) {
                    const fileName = getFileName(midi);
                    const audio = new Audio(fileName);
                    
                    audioCache[midi] = audio; // Guardem l'objecte Audio al cache

                    audio.oncanplaythrough = () => onLoaded(midi, false);
                    
                    // Si falla la càrrega d'un arxiu (generalment 404 Not Found)
                    audio.onerror = (e) => {
                        console.error(`Error de càrrega per a la nota MIDI ${midi} (${fileName}).`, e);
                        failedFiles.push(fileName);
                        onLoaded(midi, true); // Continuem amb la càrrega dels altres
                    };

                    // Forcem la càrrega
                    audio.load();
                }
            });
        }
        
        /**
         * Comprova i inicia la precàrrega. S'executa a l'inici.
         */
        function checkAudioAccessibility() {
            preloadAllAudio()
                .then(() => {
                    gameState.isAudioReady = true;
                    hideAudioErrorPopup();
                    // Amaga l'overlay de càrrega i mostra la pantalla de dificultat
                    elements.loadingOverlay.classList.add('hidden');
                    screens.difficulty.classList.remove('opacity-0');
                    console.log("Precàrrega completa. Àudio preparat per a reproducció instantània.");
                })
                .catch((error) => {
                    // Si hi ha errors, mostrem l'alerta, però permetem que el joc continuï 
                    gameState.isAudioReady = false;
                    
                    let message = `No s'han pogut carregar ${error.errorCount}/${TOTAL_MIDI_NOTES} arxius d'àudio.`;
                    
                    // Aquesta part és crucial per a la depuració
                    console.error("Fitxers fallits:", error.failedFiles);
                    if (error.failedFiles.length > 0) {
                        message += ` El primer arxiu fallit: ${error.failedFiles[0]}`;
                    }
                    showAudioErrorPopup(message);
                    
                    // Permet entrar al joc encara que hi hagi errors, però amb l'alerta.
                    elements.loadingOverlay.classList.add('hidden');
                    screens.difficulty.classList.remove('opacity-0');
                });
        }

        /**
         * Mostra el pop-up d'error d'àudio.
         * @param {string} message - Missatge addicional d'error.
         */
        function showAudioErrorPopup(message) {
            const popup = elements.audioErrorPopup;
            elements.audioErrorMessage.textContent = message;
            popup.classList.remove('hidden');
            
            setTimeout(hideAudioErrorPopup, 10000); // Mostra l'error durant 10s
        }

        /**
         * Amaga el pop-up d'error d'àudio.
         */
        function hideAudioErrorPopup() {
            elements.audioErrorPopup.classList.add('hidden');
        }

        /**
         * Reprodueix l'interval generat INSTANTÀNIAMENT utilitzant el CACHE.
         */
        function playInterval() {
            // Obtenim els objectes Audio directament del cache utilitzant les claus MIDI
            const audioBase = audioCache[gameState.baseNoteMIDI];
            const audioInterval = audioCache[gameState.intervalNoteMIDI];

            if (!audioBase || !audioInterval) {
                 elements.feedbackMessage.textContent = 'Error intern: Nota MIDI no trobada al cache.';
                 elements.feedbackMessage.classList.add('text-red-400');
                 showAudioErrorPopup("La nota requerida no es va carregar correctament. Revisa la consola per veure l'arxiu fallit.");
                 return;
            }

            // Aturar i resetar per a la reproducció instantània
            const resetAndPlay = (audio) => {
                 audio.pause();
                 audio.currentTime = 0; // Molt important per a reproducció ràpida
                 // El 'play' ha d'estar dins un bloc try/catch per capturar possibles errors del navegador
                 audio.play().catch(e => {
                    console.error("Error de reproducció:", e);
                    elements.feedbackMessage.textContent = 'Error: El navegador va bloquejar la reproducció automàtica. Fes clic a "Play" de nou.';
                    elements.feedbackMessage.classList.add('text-yellow-400');
                 });
            };

            const direction = gameState.currentDirection;
            
            try {
                if (direction === 'Ascendent') {
                    resetAndPlay(audioBase); // Nota baixa
                    setTimeout(() => resetAndPlay(audioInterval), 600); // Nota alta
                } else if (direction === 'Descendent') {
                    resetAndPlay(audioInterval); // Nota alta (sona primer)
                    setTimeout(() => resetAndPlay(audioBase), 600); // Nota baixa (sona segon)
                } else if (direction === 'Harmònic' || gameState.correctIntervalSemitones === 0) {
                    resetAndPlay(audioBase);
                    resetAndPlay(audioInterval); // Sonen simultàniament
                }
            } catch(e) {
                 console.error("Error intentant reproduir l'àudio des del cache:", e);
                 elements.feedbackMessage.textContent = 'Error de reproducció inesperat. Prova de reiniciar.';
                 elements.feedbackMessage.classList.add('text-red-400');
            }
        }


        // ===============================================
        // LÒGICA DEL JOC
        // ===============================================

        /**
         * Canvia la pantalla visible.
         * @param {string} screenId - ID de la pantalla a mostrar ('difficulty', 'quiz', 'result').
         */
        function showScreen(screenId) {
            Object.values(screens).forEach(screen => screen.classList.add('hidden'));
            screens[screenId].classList.remove('hidden');
        }

        /**
         * Inicialitza el joc i la primera ronda.
         * @param {string} difficulty - Nivell seleccionat ('easy', 'medium', 'hard').
         */
        function startGame(difficulty) {
            gameState.difficulty = difficulty;
            gameState.score = 0;
            gameState.round = 0;
            elements.score.textContent = gameState.score;
            
            showScreen('quiz');
            loadNextRound();
        }

        /**
         * Genera un interval aleatori basat en el nivell de dificultat.
         */
        function generateInterval() {
            const config = DIFFICULTY_CONFIG[gameState.difficulty];
            const availableIntervals = config.intervals;

            // 1. Selecciona un interval aleatori (en semitons)
            const intervalSemitones = availableIntervals[Math.floor(Math.random() * availableIntervals.length)];

            // 2. Determina la direcció
            let direction = 'Ascendent';
            if (intervalSemitones === 0) {
                direction = 'Harmònic'; 
            } else if (config.directions.length > 0) {
                direction = config.directions[Math.floor(Math.random() * config.directions.length)];
            }
            
            // 3. Selecciona les notes MIDI
            let baseMIDI, intervalMIDI; // baseMIDI (baixa), intervalMIDI (alta)
            
            // Determina les notes per tal que l'interval s'ajusti al rang
            if (direction === 'Ascendent' || direction === 'Harmònic') {
                // Per a Ascendent/Harmònic: La nota base ha d'estar prou baixa
                const maxBaseMIDI = MIDI_END - intervalSemitones;
                // Assegura un rang mínim de notes bases (p. ex., de MIDI_START a maxBaseMIDI)
                baseMIDI = MIDI_START + Math.floor(Math.random() * (maxBaseMIDI - MIDI_START + 1));
                intervalMIDI = baseMIDI + intervalSemitones;
            } else if (direction === 'Descendent') {
                // Per a Descendent: La nota d'interval ha d'estar prou alta
                const minIntervalMIDI = MIDI_START + intervalSemitones;
                // Assegura un rang mínim de notes (p. ex., de minIntervalMIDI a MIDI_END)
                intervalMIDI = minIntervalMIDI + Math.floor(Math.random() * (MIDI_END - minIntervalMIDI + 1));
                baseMIDI = intervalMIDI - intervalSemitones; 
            }
            
            return {
                correctIntervalSemitones: intervalSemitones,
                direction: direction,
                baseNoteMIDI: baseMIDI,      // Clau del cache (Nota Baixa)
                intervalNoteMIDI: intervalMIDI, // Clau del cache (Nota Alta)
                label: `${INTERVAL_NAMES[intervalSemitones]}`
            };
        }

        /**
         * Inicialitza una nova ronda de joc.
         */
        function loadNextRound() {
            gameState.round++;
            gameState.isAnswered = false;
            
            // Neteja l'estat anterior
            elements.feedbackMessage.textContent = '';
            elements.nextRoundButton.classList.add('hidden');
            elements.roundCount.textContent = gameState.round;
            
            // 1. Genera un nou interval i assigna les claus MIDI
            gameState.currentInterval = generateInterval();
            gameState.correctIntervalSemitones = gameState.currentInterval.correctIntervalSemitones;
            gameState.currentDirection = gameState.currentInterval.direction;
            
            gameState.baseNoteMIDI = gameState.currentInterval.baseNoteMIDI;
            gameState.intervalNoteMIDI = gameState.currentInterval.intervalNoteMIDI;

            elements.playButton.disabled = false;
            elements.playButton.classList.remove('opacity-50');
            
            elements.directionLabel.textContent = `Direcció: ${gameState.currentDirection}`;
            
            // 2. Genera els botons d'opció UTILITZANT NOMÉS ELS INTERVALS D'AQUEST NIVELL
            const optionsToUse = DIFFICULTY_CONFIG[gameState.difficulty].intervals;
            generateOptions(optionsToUse);

            // 3. Inicialitza el temporitzador
            startTimer();
            
            // 4. Reprodueix l'interval automàticament (i ràpidament!)
            playInterval();
        }

        /**
         * Genera els botons d'opció de resposta.
         * @param {Array<number>} availableOptions - Llista de semitons per mostrar com a opcions.
         */
        function generateOptions(availableOptions) {
            elements.intervalOptions.innerHTML = ''; // Neteja els botons anteriors

            // Ordenem les opcions per semitons (de petit a gran)
            availableOptions.sort((a, b) => a - b);
            
            availableOptions.forEach(semitones => {
                const name = INTERVAL_NAMES[semitones];
                const button = document.createElement('button');
                button.textContent = name;
                button.setAttribute('data-semitones', semitones);
                button.onclick = () => checkAnswer(semitones, button);
                // Classes actualitzades per a fons fosc i estil similar a Auditorum
                button.classList.add('py-3', 'px-4', 'bg-gray-700', 'text-gray-100', 'font-semibold', 'rounded-lg', 'shadow-sm', 'hover:bg-blue-600', 'hover:text-white', 'transition', 'duration-150', 'text-sm', 'md:text-base');
                elements.intervalOptions.appendChild(button);
            });
            
            // Ajustar el layout grid per acomodar el nombre de botons
            const numOptions = availableOptions.length;
            let gridLayout = 'repeat(auto-fit, minmax(100px, 1fr))';
            if (numOptions <= 6) {
                // Per a pocs botons, fem columnes iguals i grans
                gridLayout = `repeat(${numOptions}, minmax(120px, 1fr))`;
            } else if (numOptions === 8) {
                // 8 botons per a Mitjà: 4 columnes
                gridLayout = 'repeat(4, minmax(120px, 1fr))';
            } else if (numOptions === 13) {
                 // 13 botons per a Difícil: 4/5 columnes 
                gridLayout = 'repeat(auto-fit, minmax(100px, 1fr))';
            }
            elements.intervalOptions.style.gridTemplateColumns = gridLayout;
        }

        /**
         * Comprova si la resposta de l'usuari és correcta.
         */
        function checkAnswer(selectedSemitones, selectedButton) {
            if (gameState.isAnswered) return; // Evita respostes múltiples

            clearInterval(gameState.timer); // Atura el temps
            gameState.isAnswered = true;
            elements.playButton.disabled = true;
            elements.playButton.classList.add('opacity-50');

            const isCorrect = selectedSemitones === gameState.correctIntervalSemitones;

            // Deshabilita tots els botons d'opció
            Array.from(elements.intervalOptions.children).forEach(btn => {
                btn.disabled = true;
                btn.classList.remove('hover:bg-blue-600', 'bg-gray-700'); 
                btn.classList.add('cursor-not-allowed', 'opacity-80');

                const currentSemitones = parseInt(btn.getAttribute('data-semitones'));

                if (currentSemitones === gameState.correctIntervalSemitones) {
                    btn.classList.add('bg-green-500', 'text-white', 'font-bold');
                } else if (btn === selectedButton) {
                    btn.classList.add('bg-red-500', 'text-white', 'font-bold');
                }
            });

            if (isCorrect) {
                gameState.score++;
                elements.score.textContent = gameState.score;
                elements.feedbackMessage.textContent = '✅ Correcte! Interval: ' + gameState.currentInterval.label;
                elements.feedbackMessage.classList.remove('text-red-400', 'text-yellow-400');
                elements.feedbackMessage.classList.add('text-green-400'); 
            } else {
                elements.feedbackMessage.textContent = '❌ Incorrecte. La resposta era: ' + gameState.currentInterval.label;
                elements.feedbackMessage.classList.remove('text-green-400', 'text-yellow-400');
                elements.feedbackMessage.classList.add('text-red-400'); 
            }

            elements.nextRoundButton.classList.remove('hidden');
        }

        /**
         * Inicialitza el compte enrere de 30 segons.
         */
        function startTimer() {
            gameState.timeRemaining = TIMER_DURATION;
            elements.timeRemaining.textContent = TIMER_DURATION;
            elements.progressBar.style.width = '100%';
            
            if (gameState.timer) clearInterval(gameState.timer);

            gameState.timer = setInterval(() => {
                gameState.timeRemaining--;
                elements.timeRemaining.textContent = gameState.timeRemaining;
                
                const percentage = (gameState.timeRemaining / TIMER_DURATION) * 100;
                elements.progressBar.style.width = `${percentage}%`;

                elements.progressBar.classList.remove('bg-red-500', 'bg-blue-600');
                if (gameState.timeRemaining <= 10) {
                     elements.progressBar.classList.add('bg-red-500'); 
                } else {
                     elements.progressBar.classList.add('bg-blue-600'); 
                }

                if (gameState.timeRemaining <= 0) {
                    clearInterval(gameState.timer);
                    if (!gameState.isAnswered) {
                        elements.feedbackMessage.textContent = '⏱️ Temps esgotat! La resposta era: ' + gameState.currentInterval.label;
                        elements.feedbackMessage.classList.remove('text-green-400', 'text-yellow-400');
                        elements.feedbackMessage.classList.add('text-red-400');
                        elements.nextRoundButton.classList.remove('hidden');
                        gameState.isAnswered = true;

                        Array.from(elements.intervalOptions.children).forEach(btn => {
                            if (parseInt(btn.getAttribute('data-semitones')) === gameState.correctIntervalSemitones) {
                                btn.classList.add('bg-green-500', 'text-white', 'font-bold');
                            }
                            btn.disabled = true;
                            btn.classList.add('cursor-not-allowed', 'opacity-80');
                        });
                    }
                }
            }, 1000); 
        }

        /**
         * Tanca el joc i mostra la pantalla de resultats.
         */
        function endGame() {
            clearInterval(gameState.timer);
            elements.finalScore.textContent = gameState.score;
            showScreen('result');
        }
        
        /**
         * Reinicia el joc a la pantalla de selecció de dificultat.
         */
        function resetGame() {
            clearInterval(gameState.timer);
            showScreen('difficulty');
            gameState.score = 0;
            gameState.round = 0;
        }


        // ===============================================
        // INICIALITZACIÓ
        // ===============================================

        window.onload = function() {
            elements.playButton.onclick = playInterval; 
            elements.nextRoundButton.onclick = () => {
                if (gameState.round >= 10) { // Limitem a 10 rondes per al joc
                    endGame();
                } else {
                    loadNextRound();
                }
            };

            // INICIA LA PRECARREGA DE TOTS ELS MP3
            checkAudioAccessibility();
        };

    </script>

</body>
</html>
