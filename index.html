<!DOCTYPE html>
<html lang="ca">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auditorum: Entrenador d'Intervals Musicals</title>
    <!-- C√†rrega de Tailwind CSS per a un disseny responsive i r√†pid -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Configuraci√≥ de la tipografia i colors professionals */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            /* Fons fosc molt similar al de la imatge */
            background-color: #0b1122; /* Gaireb√© negre amb un toc blau fosc */
        }
        /* Estil per al bot√≥ de reproducci√≥, per fer-lo destacar */
        #playButton {
            transition: all 0.1s ease;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3), 0 2px 4px -2px rgba(0, 0, 0, 0.2);
        }
        /* Utilitzem un ombrejat Blau en l'estat hover */
        #playButton:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.4), 0 4px 6px -4px rgba(37, 99, 235, 0.3); /* blue-600 shadow */
        }
        /* Estil per a la barra de temps */
        #progressBar {
            transition: width 0.9s linear;
        }
        /* Estil per al pop-up d'error d'√†udio */
        .audio-error-popup {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 50;
        }
        /* Ombrejat per als botons de dificultat (blau fosc) */
        .difficulty-button {
            background-color: #2563eb; /* Tailwind Blue-600 */
            transition: all 0.15s ease;
            box-shadow: 0 4px 14px 0 rgba(37, 99, 235, 0.5); /* Ombrejat blau intens */
        }
        .difficulty-button:hover {
            background-color: #1d4ed8; /* Tailwind Blue-700 */
        }
        /* Estat inicial de l'app quan l'√†udio es carrega */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(11, 17, 34, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 1rem;
            z-index: 60;
            color: white;
            font-size: 1.25rem;
            border-radius: 0.75rem;
            padding: 2rem;
        }
    </style>
</head>

<body class="bg-gray-950 min-h-screen flex flex-col items-center justify-center p-4">

    <!-- POP-UP d'ERROR D'AUDIO -->
    <div id="audioErrorPopup" class="audio-error-popup hidden bg-red-600 text-white p-3 rounded-lg shadow-xl max-w-xs transition duration-300 transform scale-100">
        <p class="font-bold mb-1">‚ö†Ô∏è Error de Prec√†rrega</p>
        <p id="audioErrorMessage" class="text-sm">No s'han pogut carregar tots els fitxers d'√†udio.</p>
        <p class="text-xs mt-1 opacity-80">Assegura't que el path i la nomenclatura dels arxius sigui correcta (ex: C4.mp3, Cs4.mp3).</p>
    </div>

    <!-- Contenidor principal de l'aplicaci√≥: Fosc i amb ombra subtil -->
    <div id="appContainer" class="bg-gray-800 shadow-2xl rounded-xl w-full max-w-4xl p-8 md:p-12 border border-gray-700/50 mb-4 relative">
        
        <!-- Overlay de c√†rrega (Visible fins que es comprova/prec√†rrega l'√†udio) -->
        <div id="loadingOverlay" class="loading-overlay">
            <p class="text-center font-semibold">Carregant fitxers d'√†udio per a un joc instantani...</p>
            <div class="w-full bg-gray-600 rounded-full h-2.5 max-w-sm">
                <div class="h-2.5 bg-blue-500 rounded-full transition-all duration-300" id="preloaderBar" style="width: 0%"></div>
            </div>
            <p class="text-base text-gray-300" id="preloaderStatus"></p>
        </div>

        <!-- PANTALLA 1: SELECCI√ì DE DIFICULTAT -->
        <div id="difficultyScreen" class="opacity-0 transition-opacity duration-500">
            <header class="text-center mb-8 border-b border-blue-600 pb-4">
                <h1 class="text-4xl font-extrabold text-white tracking-tight">Auditorum</h1>
                <p class="text-xl text-blue-400 font-semibold mt-1">Entrenador d'Intervals Musicals</p>
            </header>

            <h2 class="text-2xl font-bold text-gray-100 mb-2 text-center">Benvingut/da! Tria el teu Nivell de Pr√†ctica</h2>
            <p class="text-gray-400 text-center mb-8 max-w-xl mx-auto">Practica la identificaci√≥ d'intervals musicals. L'interval √©s l'√∫nic que canvia, la nota base √©s aleat√≤ria. Tria el teu nivell.</p>

            <div class="grid md:grid-cols-3 gap-6 max-w-5xl mx-auto">
                <!-- Botons amb el color Blau Fosc -->
                <button onclick="startGame('easy')" class="difficulty-button text-white font-semibold rounded-lg hover:brightness-110 p-6 flex flex-col items-center text-center">
                    <span class="text-xl font-bold mb-2">F√†cil</span>
                    <span class="text-sm opacity-90">Intervals: Un√≠son, 2a M, 3a M, 4a J, 5a J (Ascendent)</span>
                </button>
                <button onclick="startGame('medium')" class="difficulty-button text-white font-semibold rounded-lg hover:brightness-110 p-6 flex flex-col items-center text-center">
                    <span class="text-xl font-bold mb-2">Mitj√†</span>
                    <span class="text-sm opacity-90">Intervals Majors i Justos (fins a 7a M) (Totes les direccions)</span>
                </button>
                <button onclick="startGame('hard')" class="difficulty-button text-white font-semibold rounded-lg hover:brightness-110 p-6 flex flex-col items-center text-center">
                    <span class="text-xl font-bold mb-2">Dif√≠cil</span>
                    <span class="text-sm opacity-90">Tots els intervals Crom√†tics (Ascendent i Descendent)</span>
                </button>
            </div>
        </div>

        <!-- PANTALLA 2: JOC / QUIZ -->
        <div id="quizScreen" class="hidden">
            <!-- Puntuaci√≥ i Temporitzador -->
            <div class="flex justify-between items-center mb-6 border-b border-gray-700 pb-4">
                <div class="text-xl font-medium text-gray-300">Ronda: <span id="roundCount" class="font-bold text-blue-400">1</span></div>
                <div class="text-xl font-medium text-gray-300">Puntuaci√≥: <span id="score" class="font-bold text-blue-400">0</span></div>
            </div>

            <!-- √Ärea de Reproducci√≥ i Temporitzador Visual -->
            <div class="text-center mb-8">
                <!-- Bot√≥ de reproducci√≥ Blau (Sempre actiu per a la repetici√≥) -->
                <button id="playButton" class="bg-blue-600 text-white p-4 rounded-full w-20 h-20 flex items-center justify-center mx-auto mb-4 hover:bg-blue-700 transition duration-200 focus:outline-none disabled:opacity-50 disabled:cursor-not-allowed">
                    <!-- Icona de reproducci√≥ (SVG) -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                    </svg>
                </button>
                <p id="directionLabel" class="text-lg font-semibold text-gray-300 mb-4"></p>
                <p id="debugNotes" class="text-xs text-gray-500 mb-2 invisible"></p><!-- Per a debug -->

                <!-- Barra de progr√©s del temporitzador (30 segons), utilitzant Blau -->
                <div class="w-full bg-gray-700 rounded-full h-2.5">
                    <div id="progressBar" class="bg-blue-600 h-2.5 rounded-full" style="width: 100%"></div>
                </div>
                <p class="text-sm text-gray-400 mt-2">Temps restant per respondre: <span id="timeRemaining">30</span>s</p>
            </div>

            <!-- Botons d'Opci√≥ d'Interval (Es generaran per JS) -->
            <div id="intervalOptions" class="grid gap-3 mt-8" style="grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));">
                <!-- Botons injectats aqu√≠ -->
            </div>
            
            <!-- Missatge de retroalimentaci√≥ (Feedback) -->
            <div id="feedbackMessage" class="mt-6 text-center text-lg font-bold min-h-6"></div>

            <!-- Bot√≥ de seg√ºent ronda (inicialment amagat) -->
            <button id="nextRoundButton" class="hidden w-full py-3 mt-6 bg-gray-700 text-white font-semibold rounded-lg hover:bg-gray-600 transition duration-150 shadow-lg">
                Seg√ºent Ronda
            </button>
        </div>

        <!-- PANTALLA 3: RESULTATS FINALS -->
        <div id="resultScreen" class="hidden text-center">
            <h2 class="text-3xl font-bold text-gray-100 mb-4">Resultats Finals</h2>
            <p class="text-xl text-gray-400 mb-6">Has completat la pr√†ctica!</p>
            <p class="text-4xl font-extrabold text-blue-400 mb-8">Puntuaci√≥ Final: <span id="finalScore">0</span></p>

            <!-- Bot√≥ de reset amb color principal (Blau) -->
            <button onclick="resetGame()" class="w-full py-4 px-6 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition duration-150 shadow-md">
                Tornar a comen√ßar
            </button>
        </div>

    </div>
    
    <!-- Footer/Copyright -->
    <footer class="text-center text-sm text-gray-400 mt-4 max-w-4xl w-full">
        <p>Copyright &copy; Eugeni Corchero 2025</p>
    </footer>


    <!-- L√íGICA JAVASCRIPT -->
    <script>
        // ===============================================
        // VARIABLES GLOBALS I CONFIGURACI√ì
        // ===============================================

        // RUTA DE L'√ÄUDIO: Utilitzem una ruta relativa (./audio/)
        // Aix√≤ funciona en qualsevol servidor web si la carpeta 'audio' √©s al mateix nivell que l'index.html.
        const AUDIO_PATH = './audio/'; 
        
        // RANG DE NOTES DEL TEU ARXIU MIDI (A3 a C5, inclosos)
        const MIDI_START = 57; // A3 (Nota m√©s baixa)
        const MIDI_END = 72;   // C5 (Nota m√©s alta)
        const TOTAL_MIDI_NOTES = MIDI_END - MIDI_START + 1; 

        // TEMPS D'ESPERA ENTRE NOTES PER A LA REPRODUCCI√ì SEQ√úENCIAL
        const NOTE_DELAY_MS = 700; 

        const TIMER_DURATION = 30; // Temps en segons

        // CACHE: Emmagatzemar√† tots els objectes Audio ja carregats
        const audioCache = {};

        // Mapa de semitons a noms d'intervals 
        const INTERVAL_NAMES = {
            0: 'Un√≠son', 1: '2a menor', 2: '2a Major', 3: '3a menor',
            4: '3a Major', 5: '4a Justa', 6: 'Tr√≠ton', 
            7: '5a Justa', 8: '6a menor', 9: '6a Major',
            10: '7a menor', 11: '7a Major', 12: '8a Justa'
        };

        const ALL_INTERVALS = Object.keys(INTERVAL_NAMES).map(Number);

        // CONFIGURACI√ì DELS NIVELLS DE DIFICULTAT
        const DIFFICULTY_CONFIG = {
            easy: {
                intervals: [0, 2, 4, 5, 7], // Un√≠son, 2M, 3M, 4J, 5J
                directions: ['Ascendent']
            },
            medium: {
                intervals: [0, 2, 4, 5, 7, 9, 11, 12], // Majors i Justos fins a 7M (2M, 3M, 4J, 5J, 6M, 7M, 8J)
                directions: ['Ascendent', 'Descendent', 'Harm√≤nic']
            },
            hard: {
                intervals: ALL_INTERVALS, 
                directions: ['Ascendent', 'Descendent'] 
            }
        };
        
        // Estats del joc
        let gameState = {
            difficulty: null,
            score: 0,
            round: 0,
            correctIntervalSemitones: null,
            timer: null,
            timeRemaining: TIMER_DURATION,
            currentDirection: null,
            isAnswered: false,
            baseNoteMIDI: null, 
            intervalNoteMIDI: null,
            currentInterval: null,
            isAudioReady: false, 
        };

        // Refer√®ncies al DOM
        const screens = {
            difficulty: document.getElementById('difficultyScreen'),
            quiz: document.getElementById('quizScreen'),
            result: document.getElementById('resultScreen')
        };
        const elements = {
            roundCount: document.getElementById('roundCount'),
            score: document.getElementById('score'),
            playButton: document.getElementById('playButton'),
            progressBar: document.getElementById('progressBar'),
            timeRemaining: document.getElementById('timeRemaining'),
            intervalOptions: document.getElementById('intervalOptions'),
            feedbackMessage: document.getElementById('feedbackMessage'),
            nextRoundButton: document.getElementById('nextRoundButton'),
            directionLabel: document.getElementById('directionLabel'),
            finalScore: document.getElementById('finalScore'),
            audioErrorPopup: document.getElementById('audioErrorPopup'),
            audioErrorMessage: document.getElementById('audioErrorMessage'),
            loadingOverlay: document.getElementById('loadingOverlay'),
            preloaderBar: document.getElementById('preloaderBar'),
            preloaderStatus: document.getElementById('preloaderStatus'),
            debugNotes: document.getElementById('debugNotes'),
        };


        // ===============================================
        // UTILS D'√ÄUDIO I MIDI
        // ===============================================
        
        /**
         * Converteix un n√∫mero MIDI a nom de fitxer MP3 (ex: 60 -> C4.mp3).
         * Utilitza la nomenclatura amb 's' per als sostinguts.
         * @param {number} midiNumber - El n√∫mero MIDI.
         * @returns {string} El nom del fitxer (incloent la ruta).
         */
        function getFileName(midiNumber) {
            const notesMap = [
                'C', 'Cs', 'D', 'Ds', 'E', 'F', 'Fs', 'G', 'Gs', 'A', 'As', 'B'
            ];
            const octave = Math.floor(midiNumber / 12) - 1;
            const noteIndex = midiNumber % 12;
            const finalNoteName = notesMap[noteIndex];
            
            // Retorna la URL completa al fitxer d'√†udio (ex: .../audio/A3.mp3)
            return `${AUDIO_PATH}${finalNoteName}${octave}.mp3`;
        }
        
        /**
         * Prec√†rrega (Pre-load) de tots els fitxers d'√†udio.
         */
        function preloadAllAudio() {
            return new Promise((resolve, reject) => {
                let notesLoaded = 0;
                let errors = 0;
                let failedFiles = [];

                const onLoaded = (midiNumber, isError) => {
                    notesLoaded++;
                    if (isError) errors++;
                    
                    const percentage = Math.round((notesLoaded / TOTAL_MIDI_NOTES) * 100);
                    elements.preloaderBar.style.width = `${percentage}%`;
                    elements.preloaderStatus.textContent = `Carregades ${notesLoaded}/${TOTAL_MIDI_NOTES} notes. ${errors > 0 ? '(' + errors + ' errors)' : ''}`;

                    if (notesLoaded === TOTAL_MIDI_NOTES) {
                        if (errors === 0) {
                            console.log("Prec√†rrega OK: Tots els fitxers s'han trobat.");
                            resolve();
                        } else {
                            console.error(`Prec√†rrega ERROR: ${errors} fitxers fallits.`, failedFiles);
                            reject({
                                errorCount: errors,
                                failedFiles: failedFiles
                            });
                        }
                    }
                };

                for (let midi = MIDI_START; midi <= MIDI_END; midi++) {
                    const fileName = getFileName(midi);
                    const audio = new Audio(fileName);
                    
                    audioCache[midi] = audio; 

                    audio.oncanplaythrough = () => onLoaded(midi, false);
                    audio.onerror = (e) => {
                        console.error(`Error de c√†rrega per a la nota MIDI ${midi} (${fileName}).`, e);
                        failedFiles.push(fileName);
                        onLoaded(midi, true); 
                    };
                    audio.load();
                }
            });
        }
        
        /**
         * Comprova i inicia la prec√†rrega.
         */
        function checkAudioAccessibility() {
            preloadAllAudio()
                .then(() => {
                    gameState.isAudioReady = true;
                    hideAudioErrorPopup();
                    elements.loadingOverlay.classList.add('hidden');
                    screens.difficulty.classList.remove('opacity-0');
                    console.log("Prec√†rrega completa. √Äudio preparat.");
                })
                .catch((error) => {
                    gameState.isAudioReady = false;
                    let message = `No s'han pogut carregar ${error.errorCount}/${TOTAL_MIDI_NOTES} arxius d'√†udio.`;
                    if (error.failedFiles.length > 0) {
                        message += ` Primer arxiu fallit: ${error.failedFiles[0]}`;
                    }
                    showAudioErrorPopup(message);
                    elements.loadingOverlay.classList.add('hidden');
                    screens.difficulty.classList.remove('opacity-0');
                });
        }

        function showAudioErrorPopup(message) {
            const popup = elements.audioErrorPopup;
            elements.audioErrorMessage.textContent = message;
            popup.classList.remove('hidden');
            setTimeout(hideAudioErrorPopup, 10000); 
        }

        function hideAudioErrorPopup() {
            elements.audioErrorPopup.classList.add('hidden');
        }

        /**
         * Reprodueix l'interval generat (secuencialment o harm√≤nicament).
         */
        function playInterval() {
            const audioBase = audioCache[gameState.baseNoteMIDI];
            const audioInterval = audioCache[gameState.intervalNoteMIDI];

            if (!audioBase || !audioInterval) {
                 console.error('Notes MIDI no trobades al cache. No es pot reproduir.');
                 return;
            }

            const resetAndPlay = (audio) => {
                 audio.pause();
                 audio.currentTime = 0; 
                 // Intentar reproduir, capturant possibles errors de pol√≠tica d'√†udio
                 audio.play().catch(e => {
                    if (e.name === "NotAllowedError") {
                        elements.feedbackMessage.textContent = 'üîä Permet la reproducci√≥ autom√†tica o fes clic a Play.';
                        elements.feedbackMessage.classList.add('text-yellow-400');
                    }
                 });
            };

            const direction = gameState.currentDirection;
            
            try {
                // Cas 1: Reproducci√≥ Harm√≤nica (simult√†nia) o Un√≠son (0 semitons)
                if (direction === 'Harm√≤nic' || gameState.correctIntervalSemitones === 0) {
                    resetAndPlay(audioBase);
                    // Si √©s un interval harm√≤nic diferent d'un√≠son
                    if (gameState.correctIntervalSemitones !== 0) {
                        resetAndPlay(audioInterval); 
                    }
                    console.log(`Reproduint: ${gameState.currentInterval.label} Harm√≤nic. Base: ${gameState.baseNoteMIDI}, Interval: ${gameState.intervalNoteMIDI}`);
                } 
                // Cas 2: Reproducci√≥ Seq√ºencial (Ascendent)
                else if (direction === 'Ascendent') {
                    resetAndPlay(audioBase); // 1a nota (la baixa)
                    setTimeout(() => resetAndPlay(audioInterval), NOTE_DELAY_MS); // 2a nota (la alta)
                    console.log(`Reproduint: ${gameState.currentInterval.label} Ascendent. Baixa: ${gameState.baseNoteMIDI}, Alta: ${gameState.intervalNoteMIDI}`);
                } 
                // Cas 3: Reproducci√≥ Seq√ºencial (Descendent)
                else if (direction === 'Descendent') {
                    resetAndPlay(audioInterval); // 1a nota (la alta)
                    setTimeout(() => resetAndPlay(audioBase), NOTE_DELAY_MS); // 2a nota (la baixa)
                    console.log(`Reproduint: ${gameState.currentInterval.label} Descendent. Alta: ${gameState.intervalNoteMIDI}, Baixa: ${gameState.baseNoteMIDI}`);
                }
            } catch(e) {
                 console.error("Error cr√≠tic de reproducci√≥:", e);
                 elements.feedbackMessage.textContent = 'Error de reproducci√≥ inesperat.';
                 elements.feedbackMessage.classList.add('text-red-400');
            }
        }


        // ===============================================
        // L√íGICA DEL JOC REFOR√áADA
        // ===============================================

        function showScreen(screenId) {
            Object.values(screens).forEach(screen => screen.classList.add('hidden'));
            screens[screenId].classList.remove('hidden');
        }

        function startGame(difficulty) {
            gameState.difficulty = difficulty;
            gameState.score = 0;
            gameState.round = 0;
            elements.score.textContent = gameState.score;
            
            showScreen('quiz');
            loadNextRound();
        }

        /**
         * Genera un interval aleatori amb la nota base garantida per estar dins del rang MIDI.
         */
        function generateInterval() {
            const config = DIFFICULTY_CONFIG[gameState.difficulty];
            const availableIntervals = config.intervals;

            // 1. Selecciona un interval aleatori (en semitons)
            const intervalSemitones = availableIntervals[Math.floor(Math.random() * availableIntervals.length)];

            // 2. Determina la direcci√≥
            let direction = 'Ascendent';
            if (intervalSemitones === 0) {
                direction = 'Harm√≤nic'; 
            } else if (config.directions.length > 0) {
                direction = config.directions[Math.floor(Math.random() * config.directions.length)];
            }
            
            let baseMIDI, intervalMIDI; 
            
            // 3. C√†lcul del RANG V√ÄLID per a la nota de refer√®ncia inicial (startNoteMIDI)
            let minStartMIDI = MIDI_START;
            let maxStartMIDI = MIDI_END;

            if (direction === 'Ascendent' || direction === 'Harm√≤nic') {
                // La nota de refer√®ncia (baseMIDI) ha de ser prou baixa perqu√® la nota alta 
                // (baseMIDI + semitons) no excedeixi MIDI_END.
                maxStartMIDI = MIDI_END - intervalSemitones;
            } else if (direction === 'Descendent') {
                // La nota de refer√®ncia (que sonar√† primera: intervalMIDI) ha de ser prou alta
                // perqu√® la nota baixa (intervalMIDI - semitons) no sigui inferior a MIDI_START.
                minStartMIDI = MIDI_START + intervalSemitones;
                // maxStartMIDI = MIDI_END ja √©s correcte.
            }

            // Comprovaci√≥ de seguretat: si no es pot generar cap interval v√†lid
            if (minStartMIDI > maxStartMIDI) {
                // Aix√≤ nom√©s passaria si MIDI_END - MIDI_START √©s m√©s petit que l'interval
                // m√©s gran del nivell de dificultat, cosa que no passa amb la configuraci√≥ actual.
                console.error("Error cr√≠tic: El rang MIDI no permet els intervals d'aquesta dificultat.");
                return {
                    correctIntervalSemitones: 0, 
                    direction: 'Harm√≤nic',
                    baseNoteMIDI: MIDI_START, 
                    intervalNoteMIDI: MIDI_START,
                    label: 'ERROR'
                }; 
            }

            // 4. Selecci√≥ Aleat√≤ria de la nota d'inici
            const startNoteMIDI = Math.floor(Math.random() * (maxStartMIDI - minStartMIDI + 1)) + minStartMIDI;

            if (direction === 'Ascendent' || direction === 'Harm√≤nic') {
                baseMIDI = startNoteMIDI;      // Nota base (baixa)
                intervalMIDI = baseMIDI + intervalSemitones; // Nota interval (alta)
            } else if (direction === 'Descendent') {
                intervalMIDI = startNoteMIDI; // Nota interval (alta)
                baseMIDI = intervalMIDI - intervalSemitones; // Nota base (baixa)
            }

            // Aquesta part assegura que la visualitzaci√≥ de notes sigui correcta,
            // per√≤ la l√≤gica d'√†udio es basa en baseMIDI (nota baixa) i intervalMIDI (nota alta).
            elements.debugNotes.textContent = `Notes: ${getFileName(baseMIDI).match(/(\w+\d+)\.mp3/)[1]} i ${getFileName(intervalMIDI).match(/(\w+\d+)\.mp3/)[1]}`;
            elements.debugNotes.classList.remove('invisible');

            console.log(`Interval Generat: ${INTERVAL_NAMES[intervalSemitones]} (${intervalSemitones} semitons), Direcci√≥: ${direction}, MIDI Baixa: ${baseMIDI}, MIDI Alta: ${intervalMIDI}`);

            return {
                correctIntervalSemitones: intervalSemitones,
                direction: direction,
                baseNoteMIDI: baseMIDI,      // Clau del cache (Nota Baixa)
                intervalNoteMIDI: intervalMIDI, // Clau del cache (Nota Alta)
                label: `${INTERVAL_NAMES[intervalSemitones]}`
            };
        }

        /**
         * Inicialitza una nova ronda de joc.
         */
        function loadNextRound() {
            gameState.round++;
            gameState.isAnswered = false;
            
            // Neteja l'estat anterior
            elements.feedbackMessage.textContent = '';
            elements.nextRoundButton.classList.add('hidden');
            elements.roundCount.textContent = gameState.round;
            
            // 1. Genera un nou interval i assigna les claus MIDI
            gameState.currentInterval = generateInterval();
            gameState.correctIntervalSemitones = gameState.currentInterval.correctIntervalSemitones;
            gameState.currentDirection = gameState.currentInterval.direction;
            
            gameState.baseNoteMIDI = gameState.currentInterval.baseNoteMIDI;
            gameState.intervalNoteMIDI = gameState.currentInterval.intervalNoteMIDI;

            elements.playButton.disabled = !gameState.isAudioReady;
            elements.playButton.classList.remove('opacity-50');
            
            elements.directionLabel.textContent = `Direcci√≥: ${gameState.currentDirection}`;
            
            // 2. Genera els botons d'opci√≥ UTILITZANT NOM√âS ELS INTERVALS D'AQUEST NIVELL
            const optionsToUse = DIFFICULTY_CONFIG[gameState.difficulty].intervals;
            generateOptions(optionsToUse);

            // 3. Inicialitza el temporitzador
            startTimer();
            
            // 4. Reprodueix l'interval autom√†ticament (i r√†pidament!)
            if (gameState.isAudioReady) {
                 playInterval();
            } else {
                 elements.feedbackMessage.textContent = '√Äudio no disponible. Prova de depurar la prec√†rrega.';
                 elements.feedbackMessage.classList.add('text-red-400');
            }
        }

        /**
         * Genera els botons d'opci√≥ de resposta.
         */
        function generateOptions(availableOptions) {
            elements.intervalOptions.innerHTML = ''; 
            availableOptions.sort((a, b) => a - b);
            
            availableOptions.forEach(semitones => {
                const name = INTERVAL_NAMES[semitones];
                const button = document.createElement('button');
                button.textContent = name;
                button.setAttribute('data-semitones', semitones);
                button.onclick = () => checkAnswer(semitones, button);
                button.classList.add('py-3', 'px-4', 'bg-gray-700', 'text-gray-100', 'font-semibold', 'rounded-lg', 'shadow-sm', 'hover:bg-blue-600', 'hover:text-white', 'transition', 'duration-150', 'text-sm', 'md:text-base');
                elements.intervalOptions.appendChild(button);
            });
            
            const numOptions = availableOptions.length;
            let gridLayout = 'repeat(auto-fit, minmax(100px, 1fr))';
            if (numOptions <= 6) {
                gridLayout = `repeat(${numOptions}, minmax(120px, 1fr))`;
            } else if (numOptions === 8) {
                gridLayout = 'repeat(4, minmax(120px, 1fr))';
            } else if (numOptions === 13) {
                gridLayout = 'repeat(auto-fit, minmax(100px, 1fr))';
            }
            elements.intervalOptions.style.gridTemplateColumns = gridLayout;
        }

        /**
         * Comprova si la resposta de l'usuari √©s correcta.
         */
        function checkAnswer(selectedSemitones, selectedButton) {
            if (gameState.isAnswered) return; 

            clearInterval(gameState.timer); 
            gameState.isAnswered = true;

            const isCorrect = selectedSemitones === gameState.correctIntervalSemitones;

            Array.from(elements.intervalOptions.children).forEach(btn => {
                btn.disabled = true;
                btn.classList.remove('hover:bg-blue-600', 'bg-gray-700'); 
                btn.classList.add('cursor-not-allowed', 'opacity-80');

                const currentSemitones = parseInt(btn.getAttribute('data-semitones'));

                if (currentSemitones === gameState.correctIntervalSemitones) {
                    btn.classList.add('bg-green-500', 'text-white', 'font-bold');
                } else if (btn === selectedButton) {
                    btn.classList.add('bg-red-500', 'text-white', 'font-bold');
                }
            });

            if (isCorrect) {
                gameState.score++;
                elements.score.textContent = gameState.score;
                elements.feedbackMessage.textContent = '‚úÖ Correcte! Interval: ' + gameState.currentInterval.label;
                elements.feedbackMessage.classList.remove('text-red-400', 'text-yellow-400');
                elements.feedbackMessage.classList.add('text-green-400'); 
            } else {
                elements.feedbackMessage.textContent = '‚ùå Incorrecte. La resposta era: ' + gameState.currentInterval.label;
                elements.feedbackMessage.classList.remove('text-green-400', 'text-yellow-400');
                elements.feedbackMessage.classList.add('text-red-400'); 
            }

            elements.nextRoundButton.classList.remove('hidden');
        }

        /**
         * Inicialitza el compte enrere de 30 segons.
         */
        function startTimer() {
            gameState.timeRemaining = TIMER_DURATION;
            elements.timeRemaining.textContent = TIMER_DURATION;
            elements.progressBar.style.width = '100%';
            
            if (gameState.timer) clearInterval(gameState.timer);

            gameState.timer = setInterval(() => {
                gameState.timeRemaining--;
                elements.timeRemaining.textContent = gameState.timeRemaining;
                
                const percentage = (gameState.timeRemaining / TIMER_DURATION) * 100;
                elements.progressBar.style.width = `${percentage}%`;

                elements.progressBar.classList.remove('bg-red-500', 'bg-blue-600');
                if (gameState.timeRemaining <= 10) {
                     elements.progressBar.classList.add('bg-red-500'); 
                } else {
                     elements.progressBar.classList.add('bg-blue-600'); 
                }

                if (gameState.timeRemaining <= 0) {
                    clearInterval(gameState.timer);
                    if (!gameState.isAnswered) {
                        elements.feedbackMessage.textContent = '‚è±Ô∏è Temps esgotat! La resposta era: ' + gameState.currentInterval.label;
                        elements.feedbackMessage.classList.remove('text-green-400', 'text-yellow-400');
                        elements.feedbackMessage.classList.add('text-red-400');
                        elements.nextRoundButton.classList.remove('hidden');
                        gameState.isAnswered = true;

                        Array.from(elements.intervalOptions.children).forEach(btn => {
                            if (parseInt(btn.getAttribute('data-semitones')) === gameState.correctIntervalSemitones) {
                                btn.classList.add('bg-green-500', 'text-white', 'font-bold');
                            }
                            btn.disabled = true;
                            btn.classList.add('cursor-not-allowed', 'opacity-80');
                        });
                    }
                }
            }, 1000); 
        }

        /**
         * Tanca el joc i mostra la pantalla de resultats.
         */
        function endGame() {
            clearInterval(gameState.timer);
            elements.finalScore.textContent = gameState.score;
            showScreen('result');
        }
        
        /**
         * Reinicia el joc a la pantalla de selecci√≥ de dificultat.
         */
        function resetGame() {
            clearInterval(gameState.timer);
            showScreen('difficulty');
            gameState.score = 0;
            gameState.round = 0;
            elements.debugNotes.classList.add('invisible');
        }


        // ===============================================
        // INICIALITZACI√ì
        // ===============================================

        window.onload = function() {
            elements.playButton.onclick = playInterval; 

            elements.nextRoundButton.onclick = () => {
                if (gameState.round >= 10) { // Limitem a 10 rondes per al joc
                    endGame();
                } else {
                    loadNextRound();
                }
            };

            // INICIA LA PRECARREGA DE TOTS ELS MP3
            checkAudioAccessibility();
        };

    </script>

</body>
</html>
